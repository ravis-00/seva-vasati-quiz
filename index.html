<!DOCTYPE html>
<html lang="kn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ಸೇವಾ ವಸತಿ ಪರೀಕ್ಷೆ ಹಾಗೂ ಪ್ರಮಾಣೀಕರಣ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .quiz-option:hover {
      background-color: #f0f9ff;
    }
    .quiz-option input:checked + label {
      background-color: #e0f2fe;
      border-color: #0284c7;
    }
  </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">
  <div id="quiz-container" class="w-full max-w-3xl mx-auto">
    <!-- Logo -->
    <div class="text-center mb-4">
      <img src="Logo.png" alt="Seva Vasati Logo" class="h-20 mx-auto" />
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="bg-white p-8 rounded-xl shadow-lg text-center">
      <h1 id="quiz-title" class="text-3xl font-bold text-slate-800 mb-4"></h1>
      <p class="text-slate-600 mb-2">ದಯವಿಟ್ಟು ನಿಮ್ಮ ವಿವರಗಳನ್ನು ನಮೂದಿಸಿ:</p>
      <div class="mb-6 space-y-4 text-left">
        <input type="text" id="employee-name" placeholder="ಸಿಬ್ಬಂದಿ ಹೆಸರು" class="w-full p-3 border rounded" />
        <input type="text" id="employee-id" placeholder="ಸಿಬ್ಬಂದಿ ಸಂಖ್ಯೆ" class="w-full p-3 border rounded" />
      </div>
      <p class="text-slate-600 mb-4">ಈ ಪರೀಕ್ಷೆಯಲ್ಲಿ ಆಯ್ದ ಎಲ್ಲ <span id="question-count-info"></span> ಪ್ರಶ್ನೆಗಳಿಗೆ 15 ನಿಮಿಷ ಅವಧಿಯಲ್ಲಿ ಉತ್ತರಿಸಬೇಕು.</p>
      <button onclick="startQuiz()" class="bg-orange-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-orange-700 transition-colors duration-300 shadow-md">
        Start Test
      </button>
    </div>

    <!-- Quiz Screen -->
    <div id="quiz-screen" class="hidden">
      <div class="bg-white p-8 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 id="quiz-header" class="text-2xl font-bold text-slate-800 border-b pb-2"></h2>
          <div id="timer" class="text-right text-slate-500 text-sm"></div>
        </div>
        <div id="questions-wrapper" class="space-y-8"></div>
        <div class="mt-8 text-center">
          <button onclick="submitQuiz()" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors duration-300 shadow-md">
            Submit Answers
          </button>
        </div>
      </div>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="hidden">
      <div class="bg-white p-8 rounded-xl shadow-lg text-center">
        <h2 class="text-3xl font-bold text-slate-800 mb-4">Test Complete!</h2>
        <p id="result-quiz-title" class="text-slate-600 mb-2"></p>
        <p class="text-2xl font-semibold text-slate-700 mt-6 mb-2">Your Score:</p>
        <p id="score-text" class="text-5xl font-bold text-sky-600 mb-4">0 / 0</p>
        <div id="feedback-text" class="text-slate-600 mb-4"></div>
        <div id="certificate-download" class="mt-6"></div>
        <button id="retest-button" onclick="restartQuiz()" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-sky-700 transition-colors duration-300 shadow-md hidden">
          Take This Test Again
        </button>
      </div>
    </div>
  </div>

  <script src="questions.js"></script>
  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxbrRdiGDmi20YckKlem_blVJsni4dPBpTpPWu38TEQR_qR4X9U-S2JVoqbQHH85tIA/exec";
    const PILOT_PROJECT_KEY = "seva_vasati";
    const NUMBER_OF_QUESTIONS_TO_SELECT = 5;
    const PASSING_PERCENTAGE = 80;

    let selectedQuestions = [];
    let quizTimer;

    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');

    function initialize() {
      const project = projectQuizzes?.[PILOT_PROJECT_KEY];
      if (!project) {
        document.body.innerHTML = `<div class="text-center p-8"><h2 class="text-2xl font-bold text-red-600">Configuration Error</h2><p>Ensure <strong>questions.js</strong> has key "<strong>${PILOT_PROJECT_KEY}</strong>".</p></div>`;
        return;
      }
      document.getElementById('quiz-title').textContent = project.title;
      document.getElementById('question-count-info').textContent = Math.min(NUMBER_OF_QUESTIONS_TO_SELECT, project.questions.length);
    }

    async function startQuiz() {
      const name = document.getElementById('employee-name').value.trim();
      const id = document.getElementById('employee-id').value.trim();

      if (!name || !id) {
        alert("ದಯವಿಟ್ಟು ಹೆಸರು ಮತ್ತು ಸಂಖ್ಯೆ ನಮೂದಿಸಿ.");
        return;
      }

      const eligibility = await checkEligibilityFromGoogleSheet(id);
      if (eligibility?.score >= PASSING_PERCENTAGE) {
        document.body.innerHTML = `
          <div class="bg-white p-8 rounded-xl shadow-lg text-center w-full max-w-md mx-auto">
            <h2 class="text-2xl font-bold text-green-600">You’ve Already Passed!</h2>
            <p class="mt-4 text-slate-600">You already passed with <strong>${eligibility.score}%</strong>. Retest not required.</p>
            <p class="mt-2 text-sm text-slate-500">Contact admin if you believe this is a mistake.</p>
          </div>
        `;
        return;
      }

      localStorage.setItem("employeeName", name);
      localStorage.setItem("employeeId", id);

      buildQuiz();
      startScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      startTimer(15 * 60);
    }

    async function checkEligibilityFromGoogleSheet(id) {
      try {
        const response = await fetch(`${WEB_APP_URL}?id=${encodeURIComponent(id)}`);
        const data = await response.json();
        if (data?.status === "found") return { score: parseFloat(data.score) };
        return { score: 0 };
      } catch (error) {
        alert("Could not check eligibility. Please check your connection or contact an admin.");
        return null;
      }
    }

    function buildQuiz() {
      const project = projectQuizzes[PILOT_PROJECT_KEY];
      const questionsWrapper = document.getElementById('questions-wrapper');
      document.getElementById('quiz-header').textContent = project.title;
      questionsWrapper.innerHTML = '';

      selectedQuestions = [...project.questions].sort(() => 0.5 - Math.random()).slice(0, NUMBER_OF_QUESTIONS_TO_SELECT);

      selectedQuestions.forEach((q, index) => {
        const div = document.createElement('div');
        div.innerHTML = `
          <h3 class="text-lg font-semibold text-slate-700 mb-4">${index + 1}. ${q.question}</h3>
          <div class="space-y-3" id="q${index}-options"></div>
        `;
        const optionsDiv = div.querySelector(`#q${index}-options`);
        [...q.choices].sort(() => 0.5 - Math.random()).forEach((choice, i) => {
          optionsDiv.innerHTML += `
            <div class="quiz-option">
              <input type="radio" name="question-${index}" value="${choice}" id="q${index}-option${i}" class="sr-only">
              <label for="q${index}-option${i}" class="block w-full p-4 border-2 border-slate-200 rounded-lg cursor-pointer transition-colors">${choice}</label>
            </div>
          `;
        });
        questionsWrapper.appendChild(div);
      });
    }

    function submitQuiz() {
      clearInterval(quizTimer);
      let score = 0;
      selectedQuestions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="question-${index}"]:checked`);
        if (selected?.value === q.answer) score++;
      });

      const total = selectedQuestions.length;
      const percentage = total ? (score / total) * 100 : 0;

      saveResultsToSheet({
        name: localStorage.getItem("employeeName"),
        id: localStorage.getItem("employeeId"),
        score: score,
        total: total,
        percentage: percentage.toFixed(2)
      });

      displayResults(score, total, percentage);
    }

    function saveResultsToSheet(result) {
      fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify(result)
      })
      .then(res => res.json())
      .then(data => {
        if (data.status !== 'success') console.warn("Failed to save:", data.message);
      })
      .catch(err => {
        alert("Your score could not be saved to the sheet. Please screenshot this page.");
      });
    }

    function displayResults(score, total, percent) {
      document.getElementById('score-text').textContent = `${score} / ${total}`;
      document.getElementById('result-quiz-title').textContent = projectQuizzes[PILOT_PROJECT_KEY].title;
      const feedback = document.getElementById('feedback-text');
      const cert = document.getElementById('certificate-download');
      const retest = document.getElementById('retest-button');

      cert.innerHTML = ''; // Clear previous state

      if (percent >= PASSING_PERCENTAGE) {
        feedback.textContent = "Excellent! You have a strong understanding of our processes.";
        feedback.className = "text-green-600 font-medium";
        // UPDATED: This now creates the button that calls the new function
        cert.innerHTML = `<button onclick="handleCertificateDownload()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-bold">Download Certificate</button>`;
        retest.classList.add("hidden");
      } else {
        feedback.textContent = "A review of the processes is recommended. Please try again.";
        feedback.className = "text-red-600 font-medium";
        retest.classList.remove("hidden");
      }

      quizScreen.classList.add('hidden');
      resultScreen.classList.remove('hidden');
    }

    // NEW: This function handles logging the download and opening the certificate
    function handleCertificateDownload() {
      const id = localStorage.getItem("employeeId");
      const name = localStorage.getItem("employeeName");
      const date = new Date().toLocaleDateString('en-GB'); // Format: DD/MM/YYYY

      // 1. Log the download to the Google Sheet
      fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify({ action: 'log_download', id: id })
      })
      .then(res => res.json())
      .then(data => {
          if(data.status === 'success') {
              console.log("Download logged successfully.");
          } else {
              console.error("Failed to log download:", data.message);
          }
      })
      .catch(console.error);
      
      // 2. Open the certificate page for the user in a new tab
      const certificateUrl = `certificate.html?name=${encodeURIComponent(name)}&date=${encodeURIComponent(date)}`;
      window.open(certificateUrl, '_blank');
    }

    function restartQuiz() {
      resultScreen.classList.add('hidden');
      startScreen.classList.remove('hidden');
    }

    function startTimer(seconds) {
      const timerDisplay = document.getElementById("timer");
      let remaining = seconds;

      quizTimer = setInterval(() => {
        const m = Math.floor(remaining / 60);
        const s = String(remaining % 60).padStart(2, '0');
        timerDisplay.textContent = `Time Left: ${m}:${s}`;
        if (remaining-- < 0) {
          clearInterval(quizTimer);
          alert("Time's up! Submitting your answers now.");
          submitQuiz();
        }
      }, 1000);
    }

    initialize();
  </script>
</body>
</html>
